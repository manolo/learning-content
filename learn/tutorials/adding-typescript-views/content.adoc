= Adding TypeScript Views

:type: text
:tags: migration
:description: We migrate a Vaadin 14 application to Vaadin 15, and then add a client-side view in TypeScript
:repo:
:linkattrs:
:imagesdir: ./images
:related_tutorials:

Support for TypeScript views is one of the new features in Vaadin platform 15. TypeScript views have advantages of JavaScript frontend, such as faster loading, smaller UI response latency, and offline support, while still having static type checking similar to Java.

In this tutorial we migrate a Vaadin 14 application to Vaadin 15, and then add a client-side view in TypeScript.

== Prerequisites
 
The steps in this tutorial start from an existing Vaadin 14 application. For example, you can take link:https://vaadin.com/start/lts/simple-ui[Simple App] starter.

As usual for developing Vaadin 14 applications, you need Java, Maven, Node.js, and npm installed. We recommend to use an IDE with Java and TypeScript support.

== Upgrade Vaadin dependency version

Edit the `pom.xml` file and change the version of Vaadin platform dependency to Vaadin 15, as follows:

.pom.xml excerpt with the Vaadin dependency declaration
[source, xml]
----
<properties>

    ...
    <!-- Find the latest version on https://github.com/vaadin/platform/releases -->
    <vaadin.version>15.0.0.alpha7</vaadin.version>
    ...

</properties>

...

<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>com.vaadin</groupId>
            <artifactId>vaadin-bom</artifactId>
            <version>${vaadin.version}</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>
----

Run the Maven `install` goal to verify the changes above are correct, e. g., using the terminal command:

[source, bash]
----
$ mvn install
----

== Add new frontend dependencies

We will use link:https://vaadin.com/router[Vaadin Router] for client-side views routing, and also link:https://lit-element.polymer-project.org[lit-element] for creating TypeScript views.

Run the following command to install these and add them to `package.json`:

[source, bash]
----
$ npm install --save @vaadin/router lit-element
----

== Create client-side entrypoints

In Vaadin 15, the `index.html` and `index.ts` entrypoint files are exposed for developers.

If these files are present in the `frontend` directory, their content is used to bootstrap the application, otherwise they are generated by Vaadin in the `target`.

Use the following command to generate entrypoint files in your migrated application:

[source, bash]
----
$ mvn vaadin:prepare-frontend
----

Then copy the generated files to the `frontend` directory:

[source,bash]
----
$ cp target/index.html target/index.ts frontend/
----

Below are examples of the default entrypoint file contents.

`index.html` is an HTML page template with metadata and initial content containing the client-side router outlet.

.frontend/index.html
[source,html]
----
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Polyfills for the Web Component APIs are required to use Web Components
     in the browsers that do not support these APIs natively (e.g. IE11) -->
  <script src="./VAADIN/build/webcomponentsjs/webcomponents-loader.js" defer></script>
  <style>
    body, #outlet {
      height: 100vh;
      width: 100vw;
      margin: 0;
    }
  </style>
  <!-- index.ts is included here automatically (either by the dev server or during the build) -->
</head>
<body>
  <div id="outlet"></div>
</body>
</html>
----

The `index.ts` file is a main TypeScript frontend entrypoint. It uses `Vaadin Router` to enable client-side routing.

.frontend/index.ts
[source, typescript]
----
import {Flow} from '@vaadin/flow-frontend/Flow';
import {Router} from '@vaadin/router';

const {serverSideRoutes} = new Flow({
  imports: () => import('../target/frontend/generated-flow-imports')
});

const routes = [
  // fallback to server-side Flow routes if no client-side routes match
  ...serverSideRoutes
];

const router = new Router(document.querySelector('#outlet'));
router.setRoutes(routes);
----

Start your application in a regular way and open it in a browser to verify the changes are complete. Ideally, your application works as it did before the first step.

== Create a main layout in TypeScript

TypeScript views can only be used inside client-side layouts. So before adding TypeScript views, it is necessary to create the main layout in TypeScript first.

Create the `frontend/main-layout.ts` file following the example below.

.frontend/main-layout.ts
[source, typescript]
----
import {customElement, html, LitElement, property, unsafeCSS} from 'lit-element';

// @ts-ignore: 'Router' is declared but its value is never used
import {Router} from '@vaadin/router';

import '@vaadin/vaadin-lumo-styles/all-imports';
import '@vaadin/vaadin-app-layout/theme/lumo/vaadin-app-layout';
import '@vaadin/vaadin-icons/vaadin-icons';
import '@polymer/iron-icon/iron-icon';
import {cssFromModule} from "@polymer/polymer/lib/utils/style-gather";

// @ts-ignore
import styles from './main-layout.css';

interface MenuLink {
  route: string;
  name: string;
  icon: string;
}

const menuLinks: MenuLink[] = [
  {
    route: 'Inventory',
    name: 'Inventory',
    icon: 'vaadin:edit'
  },
  {
    route: 'About',
    name: 'About',
    icon: 'vaadin:info-circle'
  }
];

@customElement('main-layout')
export class MainLayoutElement extends LitElement {
  @property({type: Object}) location: Router.Location | undefined;

  static get styles() {
    return [
      unsafeCSS(cssFromModule('lumo-typography')),
      unsafeCSS(styles)
    ];
  }

  render() {
    return html`
      <vaadin-app-layout id="layout">
        <vaadin-drawer-toggle slot="navbar" class="menu-toggle"></vaadin-drawer-toggle>
        <vaadin-horizontal-layout slot="navbar" class="menu-header" theme="spacing" style="align-items: center">
           <img src="img/table-logo.png" alt="logo">
           <label>Bookstore</label> 
        </vaadin-horizontal-layout>
        ${menuLinks.map(menuLink => html`
          <a slot="drawer"
              class="menu-link"
              href="${menuLink.route}"
              tabindex="-1"
              ?active="${this.isCurrentLocation(menuLink.route)}">
            <iron-icon icon="${menuLink.icon}"></iron-icon>
            ${menuLink.name}
          </a>
        `)}
        <slot></slot>
      </vaadin-app-layout>
    `;
  }

  private isCurrentLocation(route: string): boolean {
    if (!this.location) {
      return false;
    }

    const routeUrl = new URL(route, document.baseURI);
    return routeUrl.pathname === this.location.pathname;
  }
}
----

Create the corresponding style sheet file `frontend/main-layout.css`:

.frontend/main-layout.css
[source, css]
----
.menu-header {
    padding: 11px 16px;
    padding-left: 32px;
    font-size: var(--lumo-font-size-l);
}

.menu-toggle {
    display: none;
}

.menu-link {
    display: block;
    margin: 0 auto;
    padding: 10px 37px;
    transition: transform 300ms;

    font-family: var(--lumo-font-family);
    font-size: var(--lumo-font-size-m);
    font-weight: 500;
    color: var(--lumo-secondary-text-color);
}

.menu-link[active] {
    color: var(--lumo-body-text-color);
}

.menu-link:hover {
    text-decoration: none;
}

.menu-link span {
    padding-left: 5px;
}

.menu-button {
    padding: 10px 42px;
    color: var(--lumo-secondary-text-color);
}

/*
 * Special rules for narrow screens (responsive design rules)
 */
@media (max-width: 800px), (max-height: 600px) {

    /*
     * Make menu toggle visible, and smaller
     */
    .menu-toggle {
        display: block;
        height: var(--lumo-button-size);
        width: var(--lumo-button-size);
    }

    .menu-header {
        padding-left: 0;
    }
}
----

Edit the `frontend/index.ts` to include the main layout component in all the routes:

.frontend/index.ts
[source, typescript]
----
import {Flow} from '@vaadin/flow-frontend/Flow';
import {Router} from '@vaadin/router';

import './main-layout'

const {serverSideRoutes} = new Flow({
  imports: () => import('../target/frontend/generated-flow-imports')
});

const routes = [
  {
    path: '',
    component: 'main-layout',
    children: [
      // fallback to server-side Flow routes if no client-side routes match
      ...serverSideRoutes
    ]
  }
];

const router = new Router(document.querySelector('#outlet'));
router.setRoutes(routes);
----

[WARNING]
.Move the Java annotations from the main layout to the app shell class
====
Because the client-side bootstrapping was introduced in Vaadin 15, the Java main layout does no longer directly correspond to the initial HTML page.

Instead, the `VaadinAppShell` class is introduced for configuring the initial HTML.

From now on, the Java annotations related to the initial HTML should be , such as `@Meta`, `@Viewport`, `@Inline`, `@PWA`, should be declared on the `VaadinAppShell` subclass.

.AppShell.java
[source, java]
----
package ...;

import com.vaadin.flow.component.page.VaadinAppShell;
import com.vaadin.flow.server.PWA;
import com.vaadin.flow.theme.Theme;
import com.vaadin.flow.theme.lumo.Lumo;

@Theme(value = Lumo.class)
@PWA(name = "Bookstore", shortName = "Bookstore")
public class AppShell extends VaadinAppShell {
}
----
====

Now you can delete the `MainLayout.java` class and all its references.

Rebuild your application and reload the browser to see the changes in effect.

The next step will be purely on the frontend side. Keep your application running, restarting the server for applying the changes is unnecessary. Reloading the browser page is enough.

== Add first TypeScript view

The application structure is now prepared for adding TypeScript views. Let us create one to demonstrate that.

Create `frontend/views/example/example-view.ts` file:

.frontend/views/example/example-view.ts
[source, typescript]
----
import {customElement, html, LitElement, unsafeCSS} from 'lit-element';

import '@vaadin/vaadin-lumo-styles/all-imports';

import {cssFromModule} from "@polymer/polymer/lib/utils/style-gather";

// @ts-ignore
import styles from './example-view.css';

@customElement('example-view')
export class MainLayoutElement extends LitElement {
  static get styles() {
    return [
      unsafeCSS(cssFromModule('lumo-typography')),
      unsafeCSS(styles)
    ];
  }

  render() {
    return html`
      <h1>Example View</h1>
      <p>Insert content here...</p>
    `;
  }
}
----

And the `frontend/views/example/example-view.css` file:

.frontend/views/example/example-view.css
[source, css]
----
:host {
    display: block;
    padding: var(--lumo-space-wide-l);
}
----

Add a route to the `frontend/index.ts`:

.frontend/index.ts excerpt
[source, typescript]
----
const routes = [
  {
    path: '',
    component: 'main-layout',
    children: [
      {
        path: 'example',
        component: 'example-view',
        action: async() => {
          await import('./views/example/example-view')
        }
      },

      // fallback to server-side Flow routes if no client-side routes match
      ...serverSideRoutes
    ]
  }
];
----

Add a menu link in the `frontend/main-layout.ts`:

.frontend/main-layout.ts excerpt
[source, typescript]
----
const menuLinks: MenuLink[] = [
  // ...
  {
    route: 'Example',
    name: 'Example',
    icon: 'vaadin:file-text'
  }
];
----

After reloading the browser page, click the “Example” menu link to see the new TypeScript view.

== Conclusion

You now are able to perform the basic Vaadin 15 migration steps, and know how to add a TypeScript view to a Vaadin project.
